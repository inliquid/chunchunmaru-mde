"use strict";function chunchunmaru(t,o){if(void 0===t)throw"First parameter (container id) cannot be null.";o=o||{};var e,o=this.settings=Object.assign({attributes:{id:"chunchunmaru-textarea",name:"chunchunmaru-textarea",placeholder:"Start writting!"},atLink:!1,atLinkBase:"https://github.com/",autoSave:!1,csrfToken:null,gfm:!0,livePreview:!1,livePreviewContainer:"",previewCodeHighlight:!1,sanitize:!0,saveHTML:!1,toolbar:["bold","italic","strikethrough","|","link","blockquote","code","image","uploadImage","|","center","ol","ul","|","h1","h2","h3","h4","h5","h6","|","undo","redo"],imageUploadUrl:null},o);if(this.regexs={atLink:/@(\w+)/g,email:/(\w+)@(\w+)\.(\w+)\.?(\w+)?/g,emailLink:/(mailto:)?([\w\.\_]+)@(\w+)\.(\w+)\.?(\w+)?/g,emoji:/:([\w\+-]+):/g,emojiDatetime:/(\d{2}:\d{2}:\d{2})/g,twemoji:/:(tw-([\w]+)-?(\w+)?):/g,pageBreak:/^\[[=]{8,}\]$/},this.loadScript=function(t,e,i){i=i||"body",e=e||function(){};var n=document.createElement("script");n.type="text/javascript",n.src=t,n.setAttribute("async",""),"Microsoft Internet Explorer"==navigator.appName&&"8."==navigator.appVersion.match(/8./i)?n.onreadystatechange=function(){n.readyState&&("loaded"!==n.readyState&&"complete"!==n.readyState||(n.onreadystatechange=null,e()))}:n.onload=function(){e()},("body"===i?document.getElementsByTagName("body")[0]:document.body).appendChild(n)},this.loadCSS=function(t,e,i){i=i||"head",e=e||function(){};var n=document.createElement("link");n.type="text/css",n.rel="stylesheet",n.onload=n.onreadystatechange=function(){e()},n.href=t,("head"===i?document.getElementsByTagName("head")[0]:document.body).appendChild(n)},this.loadScript("https://code.iconify.design/1/1.0.7/iconify.min.js"),o.livePreview&&(this.previewContainer=document.querySelector(this.settings.livePreviewContainer)),"undefined"!=typeof marked){if(o.previewCodeHighlight&&"undefined"==typeof hljs)throw"highlight.js is not defined";var i=new marked.Renderer,n=this.regexs.atLink,a=this.regexs.email;i.paragraph=t=>o.atLink?t=n.test(t)?(t=t.replace(a,function(t,e,i,n){return t.replace(/@/g,"_#_&#64;_#_")})).replace(n,function(t,e){return'<a href="'+o.atLinkBase+e+'" title="&#64;'+e+'" class="at-link">'+t+"</a>"}).replace(/_#_&#64;_#_/g,"@"):t:t;i=this.markedOptions={gfm:o.gfm,tables:!0,breaks:!0,pedantic:!1,smartLists:!0,smartypants:!1,highlight:!!o.previewCodeHighlight&&function(t,e){e=hljs.getLanguage(e)?e:"plaintext";return hljs.highlight(t,{language:e}).value},langPrefix:o.previewCodeHighlight?"hljs lang-":"lang-"};marked.setOptions(i)}if(o.sanitize){if("undefined"==typeof DOMPurify)throw"DOMPurify is not defined";DOMPurify.addHook("uponSanitizeElement",(t,e)=>{if("iframe"===e.tagName){const i=t.getAttribute("src")||"";if(!i.startsWith("https://www.youtube.com/embed/"))return t.parentNode.removeChild(t)}})}for(e in this.container=document.getElementById(t),this.toolbar=document.createElement("div"),this.textarea=this.container.getElementsByTagName("textarea")[0]||document.createElement("textarea"),o.attributes){var r=o.attributes[e];this.textarea.getAttribute(e)||this.textarea.setAttribute(e,r)}this.container.className+=" chunchumaru-container",this.toolbar.className+=" chunchunmaru-editor-toolbar",this.textarea.className+=" chunchunmaru-editor";t=this.container.children[0];this.container.appendChild(this.toolbar),void 0===t?this.container.appendChild(this.textarea):this.container.appendChild(t),this.fileInput=document.createElement("input"),this.fileInput.type="file",this.fileInput.style.display="none",this.fileInput.addEventListener("change",()=>{var t=this.fileInput;const a=this.settings.imageUploadUrl;if(t.files&&t.files[0]){const r=t.files[0],e=new FileReader;e.addEventListener("load",async t=>{if(a){const i=new FormData;i.append("image",r),o.csrfToken&&i.append("csrfmiddlewaretoken",o.csrfToken);const n=await fetch(a,{method:"POST",credentials:"same-origin",body:i});if(!n.ok)throw n.text;var e=await n.json();console.log(e),this.insertString(`\n![](${e.url})\n`)}else{t=t.target.result;this.insertString(`![](${t})`)}}),e.readAsDataURL(r)}}),this.container.appendChild(this.fileInput);var s=[""],l=[];this.triggerUndo=function(){1<s.length&&(l.push(this.textarea.value),this.textarea.value=s.pop())},this.triggerRedo=function(){l.length&&(s.push(this.textarea.value),this.textarea.value=l.pop())},this.hotkeys={b:t=>{!t.ctrlKey||t.shiftKey||t.altKey||this.buttons.bold.action()},i:t=>{!t.ctrlKey||t.shiftKey||t.altKey||this.buttons.italic.action()},l:t=>{!t.ctrlKey||t.shiftKey||t.altKey||this.buttons.link.action()},q:t=>{!t.ctrlKey||t.shiftKey||t.altKey||this.buttons.blockquote.action()},k:t=>{!t.ctrlKey||t.shiftKey||t.altKey||this.buttons.code.action()},g:t=>{!t.ctrlKey||t.shiftKey||t.altKey||this.buttons.image.action()},o:t=>{!t.ctrlKey||t.shiftKey||t.altKey||this.buttons.ol.action()},u:t=>{!t.ctrlKey||t.shiftKey||t.altKey||this.buttons.ul.action()},z:t=>{!t.ctrlKey||t.shiftKey||t.altKey||this.buttons.undo.action()},y:t=>{!t.ctrlKey||t.shiftKey||t.altKey||this.buttons.redo.action()}},this.hotkeys=Object.assign(this.hotkeys,o.hotkeys),this.textarea.addEventListener("keyup",t=>{t.key in this.hotkeys&&(!t.ctrlKey||t.shiftKey||t.altKey||(t.preventDefault(),this.hotkeys[t.key](t))),t.ctrlKey||t.shiftKey||t.altKey||"Tab"===t.key&&this.insertString("\t"),o.livePreview&&(this.previewContainer.innerHTML=this.getHTML())}),this.textarea.addEventListener("keydown",t=>{var e=t.key;if(" "!==e&&"Backspace"!==e&&"Delete"!==e||(l.length&&(l=[]),20<s.length&&s.shift(),s.push(this.textarea.value)),"Tab"===e&&t.preventDefault(),!t.shiftKey&&!t.altKey&&t.ctrlKey){switch(e){case"z":case"y":t.preventDefault()}t.key in this.hotkeys&&t.preventDefault()}});var h=this.buttons={bold:{action:()=>{this.wrapSelection("**","**")},icon:"mdi mdi-format-bold",name:"format_bold",title:"Bold selection Ctrl + B"},italic:{action:()=>{this.wrapSelection("_","_")},icon:"mdi mdi-format-italic",name:"format_italic",title:"Italic selection Ctrl + I"},strikethrough:{action:()=>{this.wrapSelection("~~","~~")},icon:"mdi mdi-format-strikethrough-variant",name:"format_strikethrough",title:"Strikethorugh selection"},link:{action:()=>{this.wrapSelection("[","](put_your_link_url_here)")},icon:"mdi mdi-link-variant",name:"link",title:"Add link Ctrl + L"},blockquote:{action:()=>{this.addPrefixToSelectedLine("> ")},icon:"mdi mdi-format-quote-close",name:"format_quote",title:"Blockquote Ctrl + Q"},code:{action:()=>{this.wrapSelection("\n```python\n","\n```\n")},icon:"mdi mdi-code-braces",name:"code",title:"Code sample Ctrl + K"},image:{action:()=>{this.wrapSelection("![your image description](",")","put_your_image_url_here")},icon:"mdi mdi-image",name:"image",title:"Image Ctrl + G"},uploadImage:{action:()=>{this.fileInput.click()},icon:"mdi mdi-image-plus",name:"add_photo_alternate",title:"Upload Image"},center:{action:()=>{this.wrapSelection("<div align='center'>\n\n","\n\n</div>")},icon:"mdi mdi-format-align-center",name:"format_align_center"},ol:{action:()=>{this.addOrderToSelectedLine()},icon:"mdi mdi-format-list-numbered",name:"format_list_numbered",title:"Numbered List Ctrl + O"},ul:{action:()=>{this.addPrefixToSelectedLine("- ")},icon:"mdi mdi-format-list-bulleted",name:"format_list_bulleted",title:"Bulleted List Ctrl + U"},h1:{action:()=>{this.addPrefixToSelectedLine("# ")},icon:"mdi mdi-format-header-1",name:"title"},h2:{action:()=>{this.addPrefixToSelectedLine("## ")},icon:"mdi mdi-format-header-2",name:"title"},h3:{action:()=>{this.addPrefixToSelectedLine("### ")},icon:"mdi mdi-format-header-3",name:"title"},h4:{action:()=>{this.addPrefixToSelectedLine("#### ")},icon:"mdi mdi-format-header-4",name:"title"},h5:{action:()=>{this.addPrefixToSelectedLine("##### ")},icon:"mdi mdi-format-header-5",name:"title"},h6:{action:()=>{this.addPrefixToSelectedLine("###### ")},icon:"mdi mdi-format-header-6",name:"title"},undo:{action:()=>{this.triggerUndo()},icon:"mdi mdi-undo",name:"undo",title:"Undo Ctrl + Z"},redo:{action:()=>{this.triggerRedo()},icon:"mdi mdi-redo",name:"redo",title:"Redo Ctrl + Y"}};this.initToolbar=()=>{var t,e,i,n;for(t of this.settings.toolbar)t in h?(e=h[t],(i=document.createElement("span")).className+="iconify toolbar-button-icon ",i.setAttribute("data-icon",e.icon.slice(4)),i.setAttribute("data-inline","false"),(n=document.createElement("button")).onclick=e.action,n.title=e.title,n.type="button",n.appendChild(i),this.toolbar.appendChild(n)):"|"===t&&((n=document.createElement("hr")).setAttribute("role","separator"),n.setAttribute("aria-orientation","vertical"),n.className+="toolbar-button-divider",this.toolbar.appendChild(n));this.toolbar.addEventListener("click",()=>{o.livePreviewContainer&&(this.previewContainer.innerHTML=this.getHTML())}),this.toolbar.addEventListener("mousedown",function(t){t.preventDefault()})},this.initToolbar(),o.livePreview&&(this.previewContainer.innerHTML=this.getHTML())}chunchunmaru.prototype.wrapSelection=function(t,e,i=""){var n=this.textarea,a=n.value,r=n.selectionStart,o=n.selectionEnd;let s=i;if(r!==o){s=a.substring(r,o);let t=s.replace(/\s*$/,"").length;s.length!==t&&(o=(r=n.selectionStart)+t,s=a.substring(r,o)),t=s.replace(/^\s*/,"").length,s.length!==t&&(r=o-t,s=a.substring(r,o))}i=t+s+e,e=a.substring(0,r),n=a.substring(o,n.value.length);this.textarea.value=e+i+n,this.textarea.selectionStart=r+t.length+s.length,this.textarea.selectionEnd=r+t.length+s.length},chunchunmaru.prototype.insertString=function(t){var e=this.textarea.value,i=this.textarea.selectionStart,n=e.substring(0,i),e=e.substring(i,e.length);this.textarea.value=n+t+e,this.textarea.selectionStart=i+t.length,this.textarea.selectionEnd=i+t.length},chunchunmaru.prototype.addPrefixToSelectedLine=function(t){var e=this.textarea,i=e.selectionStart,n=e.selectionEnd;if(i==n){var a=e.value.substr(0,i).split("\n").length-1;(s=e.value.split("\n"))[a]=t+s[a]}else{var r=e.value.substr(0,i).split("\n").length-1,o=e.value.substr(0,n).split("\n").length-1,s=e.value.split("\n");for(o<r&&(e=o,o=r,r=e);r<=o;)s[r]=t+s[r],r+=1}this.textarea.value=s.join("\n")},chunchunmaru.prototype.addOrderToSelectedLine=function(){var t=this.textarea,e=t.selectionStart,i=t.selectionEnd,n=1;if(e==i){var a=t.value.substr(0,e).split("\n").length-1;(s=t.value.split("\n"))[a]=`${n}. `+s[a]}else{var r=t.value.substr(0,e).split("\n").length-1,o=t.value.substr(0,i).split("\n").length-1,s=t.value.split("\n");for(o<r&&(t=o,o=r,r=t);r<=o;)s[r]=`${n}. `+s[r],r+=1,n+=1}this.textarea.value=s.join("\n")},chunchunmaru.prototype.saveMarkdownToInnerHTML=function(){this.textarea.innerHTML=this.textarea.value},chunchunmaru.prototype.getHTML=function(){var t=marked(this.textarea.value);return this.settings.sanitize?DOMPurify.sanitize(t):t},chunchunmaru.markdownToHTML=function(t,e){if(e=e||{},e=Object.assign({gfm:!0,previewCodeHighlight:!1,sanitize:!0},e),"undefined"==typeof marked)throw"marked is not defined";var i=!1;if(e.previewCodeHighlight){if("undefined"==typeof hljs)throw"hljs is undefined";i=function(t,e){e=hljs.getLanguage(e)?e:"plaintext";return hljs.highlight(t,{language:e}).value}}if(e.sanitize&&"undefined"==typeof DOMPurify)throw"DOMPurify is not defined";i=this.markedOptions={gfm:e.gfm,tables:!0,breaks:!0,pedantic:!1,smartLists:!0,smartypants:!1,highlight:i,langPrefix:e.previewCodeHighlight?"hljs lang-":"lang-"};marked.setOptions(i);t=marked(t);return e.sanitize?DOMPurify.sanitize(t):t},"function"==typeof require&&"object"==typeof exports&&"object"==typeof module?module.exports=chunchunmaru:window.chunchunmaru=chunchunmaru;